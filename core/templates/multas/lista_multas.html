{% extends "base.html" %}

{% block title %}multas{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1400px;">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="mb-1">
        <i class="bi bi-cash-coin text-primary"></i>
        {% if es_admin %}gestión de multas{% else %}mis multas{% endif %}
      </h1>
      <p class="text-muted mb-0" style="font-size: 0.875rem;">
        {% if es_admin %}administra todas las multas{% else %}consulta y paga tus multas{% endif %}
      </p>
    </div>
    {% if es_admin %}
    <a href="{% url 'crear_multa' %}" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> nueva multa
    </a>
    {% endif %}
  </div>

  {% if not es_admin %}
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <i class="bi bi-cash-stack text-warning" style="font-size: 2rem;"></i>
          <h3 class="mt-2 mb-0">{{ multas_pendientes }}</h3>
          <small class="text-muted">multas pendientes</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <i class="bi bi-currency-dollar text-danger" style="font-size: 2rem;"></i>
          <h3 class="mt-2 mb-0">Q{{ total_pendiente|floatformat:2 }}</h3>
          <small class="text-muted">total por pagar</small>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card">
        <div class="card-body text-center">
          <i class="bi bi-check-circle text-success" style="font-size: 2rem;"></i>
          <h3 class="mt-2 mb-0">{{ multas_pagadas }}</h3>
          <small class="text-muted">multas pagadas</small>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Lista de multas -->
  {% if multas %}
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>descripción</th>
              <th style="width: 120px;">monto</th>
              {% if es_admin %}
              <th style="width: 140px;">usuario</th>
              {% endif %}
              <th style="width: 110px;">fecha</th>
              <th style="width: 120px;">estado</th>
              <th style="width: 120px;" class="text-end">acciones</th>
            </tr>
          </thead>
          <tbody>
            {% for multa in multas %}
              <tr>
                <td>
                  <div class="fw-semibold">{{ multa.descripcion|truncatewords:8 }}</div>
                  {% if multa.descripcion|length > 50 %}
                    <small class="text-muted">{{ multa.descripcion|truncatewords:15 }}</small>
                  {% endif %}
                </td>

                <td>
                  <span class="fw-bold text-danger">Q{{ multa.monto|floatformat:2 }}</span>
                </td>

                {% if es_admin %}
                <td>
                  <small>{{ multa.vecino.username }}</small>
                </td>
                {% endif %}

                <td>
                  <small class="text-muted">{{ multa.fecha|date:"d/m/Y" }}</small>
                </td>

                <!-- Estado -->
                <td>
                  {% if multa.estado == "Pendiente" %}
                    <span class="badge bg-warning text-dark">pendiente</span>
                  {% else %}
                    <span class="badge bg-success">pagada</span>
                  {% endif %}
                </td>

                <!-- Acciones -->
                <td class="text-end">
                  <div class="btn-group btn-group-sm">
                    {% if multa.estado == "Pendiente" %}
                      {% if es_admin %}
                        <a href="{% url 'marcar_pagada' multa.id %}" class="btn btn-outline-success" title="marcar pagada">
                          <i class="bi bi-check-circle"></i>
                        </a>
                      {% endif %}
                      <a href="{% url 'editar_multa' multa.id %}" class="btn btn-outline-warning" title="editar">
                        <i class="bi bi-pencil"></i>
                      </a>
                    {% endif %}
                    {% if es_admin %}
                      <a href="{% url 'eliminar_multa' multa.id %}" class="btn btn-outline-danger" title="eliminar">
                        <i class="bi bi-trash"></i>
                      </a>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    {% if is_paginated %}
    <nav class="mt-4">
      <ul class="pagination justify-content-center">
        {% if page_obj.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page=1"><i class="bi bi-chevron-double-left"></i></a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}"><i class="bi bi-chevron-left"></i></a>
          </li>
        {% endif %}

        <li class="page-item active">
          <span class="page-link">{{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
        </li>

        {% if page_obj.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}"><i class="bi bi-chevron-right"></i></a>
          </li>
          <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}"><i class="bi bi-chevron-double-right"></i></a>
          </li>
        {% endif %}
      </ul>
    </nav>
    {% endif %}

  {% else %}
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="bi bi-cash-coin text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
        <h3 class="mt-4 mb-2">sin multas</h3>
        <p class="text-muted mb-0">
          {% if es_admin %}
            las multas registradas aparecerán aquí
          {% else %}
            no tienes multas registradas
          {% endif %}
        </p>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}