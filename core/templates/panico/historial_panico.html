{% extends "base.html" %}
{% block title %}Historial de Alertas{% endblock %}

{% block content %}
<div class="container-fluid" style="max-width: 1400px;">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="mb-1">
        <i class="bi bi-shield-exclamation text-primary"></i>
        historial de alertas de pánico
      </h1>
      <p class="text-muted mb-0" style="font-size: 0.875rem;">
        registro completo de todas las alertas
      </p>
    </div>
  </div>

  {% if alertas %}
    <div class="card">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th style="width: 60px;"></th>
              <th>usuario</th>
              <th style="width: 170px;">fecha y hora</th>
              <th style="width: 150px;">estado</th>
              <th style="width: 180px;" class="text-end">acciones</th>
            </tr>
          </thead>

          <tbody>
            {% for alerta in alertas %}
              <tr class="{% if alerta.activo %}table-danger{% endif %}">

                <!-- Ícono -->
                <td class="text-center">
                  {% if alerta.activo %}
                    <i class="bi bi-shield-fill-exclamation text-danger pulse" style="font-size: 1.8rem;"></i>
                  {% else %}
                    <i class="bi bi-shield-check text-success" style="font-size: 1.8rem;"></i>
                  {% endif %}
                </td>

                <!-- Usuario -->
                <td>
                  <div class="fw-semibold">{{ alerta.vecino.username }}</div>
                  <small class="text-muted">{{ alerta.vecino.email }}</small>
                </td>

                <!-- Fecha -->
                <td>
                  <div class="fw-semibold">{{ alerta.fecha|date:"d/m/Y" }}</div>
                  <small class="text-muted">{{ alerta.fecha|date:"H:i:s" }}</small>
                </td>

                <!-- Estado -->
                <td>
                  {% if alerta.activo %}
                    <span class="badge bg-danger">
                      <i class="bi bi-exclamation-triangle"></i> activa
                    </span>
                  {% else %}
                    <span class="badge bg-success">
                      <i class="bi bi-check-circle"></i> desactivada
                    </span>
                    {% if alerta.fecha_atencion %}
                      <div>
                        <small class="text-muted">
                          {{ alerta.fecha_atencion|date:"d/m/Y H:i" }}
                        </small>
                      </div>
                    {% endif %}
                  {% endif %}
                </td>

                <!-- Acciones -->
                <td class="text-end">
                  {% if alerta.activo and request.user.es_administrador %}
                    <form method="post" action="{% url 'desactivar_panico' alerta.id %}">
                      {% csrf_token %}
                      <button type="submit" class="btn btn-outline-danger btn-sm">
                        <i class="bi bi-x-circle"></i> desactivar
                      </button>
                    </form>
                  {% elif not alerta.activo %}
                    <small class="text-muted">
                      desactivada por 
                      {% if alerta.atendido_por %}
                        {{ alerta.atendido_por.username }}
                      {% else %}
                        sistema
                      {% endif %}
                    </small>
                  {% endif %}
                </td>

              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  {% else %}
    <div class="card">
      <div class="card-body text-center py-5">
        <i class="bi bi-shield-check text-muted" style="font-size: 4rem; opacity: 0.3;"></i>
        <h3 class="mt-3 mb-2">sin alertas registradas</h3>
        <p class="text-muted">nadie ha activado el botón de pánico todavía</p>
      </div>
    </div>
  {% endif %}
</div>

<style>
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
.pulse { animation: pulse 2s ease-in-out infinite; }
.table-danger { background-color: rgba(220,53,69,0.08) !important; }
.table-danger:hover { background-color: rgba(220,53,69,0.12) !important; }
</style>

{% endblock %}
